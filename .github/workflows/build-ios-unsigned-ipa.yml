name: iOS Unsigned IPA (BlueWallet)

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [ master, main ]

concurrency:
  group: ios-unsigned-ipa-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write

jobs:
  build-ios-unsigned-ipa:
    runs-on: macos-latest
    timeout-minutes: 90

    env:
      CI: "true"
      NPM_CONFIG_AUDIT: "false"
      NPM_CONFIG_FUND: "false"

      WORKSPACE: ios/BlueWallet.xcworkspace
      SCHEME: BlueWallet
      CONFIGURATION: Release

      ARCHIVE_PATH: build/BlueWallet-Unsigned.xcarchive
      IPA_NAME: BlueWallet-unsigned.ipa

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Environment info
        shell: bash
        run: |
          set -euxo pipefail
          sw_vers
          xcodebuild -version
          xcodebuild -showsdks

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install JS dependencies
        shell: bash
        run: |
          set -euxo pipefail
          if [ -f package-lock.json ]; then
            npm ci
          elif [ -f yarn.lock ]; then
            corepack enable
            yarn --version
            yarn install --frozen-lockfile
          elif [ -f pnpm-lock.yaml ]; then
            corepack enable
            pnpm --version
            pnpm install --frozen-lockfile
          else
            npm install
          fi

      - name: Detect Ruby version (from repo)
        id: rubyver
        shell: bash
        run: |
          set -euo pipefail
          RUBY_VER=""
          if [ -f .ruby-version ]; then
            RUBY_VER="$(head -n 1 .ruby-version | tr -d '[:space:]')"
          fi
          if [ -z "$RUBY_VER" ]; then
            for f in Gemfile ios/Gemfile; do
              if [ -f "$f" ]; then
                v="$(grep -E '^\s*ruby\s+["'\'']([0-9]+\.[0-9]+\.[0-9]+)["'\'']' "$f" \
                  | head -n 1 \
                  | sed -E 's/^\s*ruby\s+["'\'']([0-9]+\.[0-9]+\.[0-9]+)["'\''].*/\1/')"
                if [ -n "${v:-}" ]; then
                  RUBY_VER="$v"
                  break
                fi
              fi
            done
          fi
          if [ -z "$RUBY_VER" ]; then
            RUBY_VER="3.1.6"
          fi
          echo "ruby=$RUBY_VER" >> "$GITHUB_OUTPUT"
          echo "Detected Ruby: $RUBY_VER"

      - name: Setup Ruby (match repo requirement)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ steps.rubyver.outputs.ruby }}
          bundler-cache: ${{ hashFiles('Gemfile.lock', 'ios/Gemfile.lock') != '' }}

      - name: Ensure CocoaPods available
        shell: bash
        run: |
          set -euxo pipefail
          if ! command -v pod >/dev/null 2>&1; then
            sudo gem install cocoapods -N
          fi
          pod --version

      - name: Install iOS Pods
        shell: bash
        run: |
          set -euxo pipefail
          test -d ios
          test -f ios/Podfile

          npx pod-install || true

          if [ ! -d ios/Pods ]; then
            if [ -f ios/Gemfile ]; then
              (cd ios && bundle exec pod install --repo-update)
            elif [ -f Gemfile ]; then
              (cd ios && bundle exec pod install --repo-update)
            else
              (cd ios && pod install --repo-update)
            fi
          fi

      - name: Sanity check workspace/scheme
        shell: bash
        run: |
          set -euxo pipefail
          test -d "${WORKSPACE}"
          xcodebuild -list -workspace "${WORKSPACE}" | tee build-schemes.txt

      # ✅ 关键修复：CI里把 Scheme 里所有 “Watch” 相关 target 从 BuildAction 里移除
      # 这样就不会去编译 BlueWalletWatch 的 Assets.xcassets（你现在就是死在这一步）
      - name: Patch scheme to exclude Watch targets (CI only)
        shell: bash
        run: |
          set -euxo pipefail

          # 找到对应 xcscheme 文件
          SCHEME_FILE="$(find ios -path "*xcshareddata/xcschemes/${SCHEME}.xcscheme" -print -quit || true)"
          if [ -z "$SCHEME_FILE" ]; then
            echo "Cannot find scheme file for ${SCHEME}.xcscheme"
            find ios -path "*xcshareddata/xcschemes/*.xcscheme" -maxdepth 6 -print || true
            exit 1
          fi

          echo "Scheme file: $SCHEME_FILE"
          cp -v "$SCHEME_FILE" "${SCHEME_FILE}.bak"

          python3 - <<'PY' "$SCHEME_FILE"
          import sys
          import xml.etree.ElementTree as ET

          path = sys.argv[1]
          tree = ET.parse(path)
          root = tree.getroot()

          ba = root.find("BuildAction")
          if ba is None:
            print("No BuildAction found, skip")
            sys.exit(0)

          entries = ba.find("BuildActionEntries")
          if entries is None:
            print("No BuildActionEntries found, skip")
            sys.exit(0)

          removed = 0
          for e in list(entries):
            br = e.find("BuildableReference")
            if br is None:
              continue
            name = br.get("BlueprintName", "") or ""
            # 删除所有包含 Watch 的 target（BlueWalletWatch / Watch Extension 等）
            if "Watch" in name:
              entries.remove(e)
              removed += 1

          tree.write(path, encoding="UTF-8", xml_declaration=True)
          print(f"Removed {removed} Watch build entries from scheme.")
          PY

          # 简单对比一下
          echo "Diff (if any):"
          (diff -u "${SCHEME_FILE}.bak" "$SCHEME_FILE" || true) | sed -n '1,200p'

      - name: Build archive (NO signing)
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p build

          export NODE_BINARY="$(command -v node)"
          echo "NODE_BINARY=$NODE_BINARY"

          set +e
          xcodebuild \
            -workspace "${WORKSPACE}" \
            -scheme "${SCHEME}" \
            -configuration "${CONFIGURATION}" \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -archivePath "${ARCHIVE_PATH}" \
            SKIP_INSTALL=NO \
            ENABLE_BITCODE=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            PROVISIONING_PROFILE="" \
            archive | tee build/xcodebuild.log
          RET=${PIPESTATUS[0]}
          set -e
          exit $RET

      - name: Inspect archive products (debug)
        shell: bash
        run: |
          set -euxo pipefail
          test -d "${ARCHIVE_PATH}"
          ls -lah "${ARCHIVE_PATH}/Products/Applications" || true
          find "${ARCHIVE_PATH}/Products/Applications" -maxdepth 2 -type d -name "*.app" -print || true

      - name: Package unsigned IPA (Payload/*.app)
        shell: bash
        run: |
          set -euxo pipefail
          test -d "${ARCHIVE_PATH}"

          APP_DIR="$(find "${ARCHIVE_PATH}/Products/Applications" -maxdepth 1 -type d -name '*.app' | head -n 1 || true)"
          if [ -z "$APP_DIR" ] || [ ! -d "$APP_DIR" ]; then
            echo "No .app found in xcarchive:"
            find "${ARCHIVE_PATH}" -maxdepth 6 -type d -name "*.app" -print || true
            exit 1
          fi

          rm -rf Payload "${IPA_NAME}"
          mkdir -p Payload
          /usr/bin/ditto "$APP_DIR" "Payload/$(basename "$APP_DIR")"
          /usr/bin/zip -qry "${IPA_NAME}" Payload

          echo "IPA created:"
          ls -lah "${IPA_NAME}"

      - name: Verify IPA exists
        shell: bash
        run: |
          set -euxo pipefail
          test -f "${IPA_NAME}"
          ls -lah "${IPA_NAME}"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: BlueWallet-unsigned-ipa
          path: ${{ env.IPA_NAME }}
          if-no-files-found: error
          retention-days: 7

      - name: Upload logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-logs
          path: |
            build/xcodebuild.log
            build-schemes.txt
          if-no-files-found: ignore
          retention-days: 7
