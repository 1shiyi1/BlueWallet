name: iOS Unsigned IPA (BlueWallet)

on:
  workflow_dispatch:

jobs:
  build-ios-unsigned-ipa:
    runs-on: macos-13

    env:
      WORKSPACE: ios/BlueWallet.xcworkspace
      SCHEME: BlueWallet
      CONFIGURATION: Release
      ARCHIVE_PATH: build/BlueWallet.xcarchive
      IPA_NAME: BlueWallet-unsigned.ipa

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 关键：锁定 Xcode 版本，避免你在 15.4 上遇到的 Widgets 并发错误直接变成 error
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "15.2"

      - name: Show Xcode version
        run: |
          set -euxo pipefail
          xcodebuild -version
          xcodebuild -showsdks

      # Node：RN 打包/脚本会用到
      - name: Setup Node (from .nvmrc if present)
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: yarn

      - name: Install JS dependencies
        run: |
          set -euxo pipefail
          if [ -f yarn.lock ]; then
            corepack enable
            yarn --version
            yarn install --frozen-lockfile
          elif [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      # 关键：Ruby 必须匹配 Gemfile (你日志里就是这里炸的)
      - name: Setup Ruby 3.1.6 (Gemfile requirement)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.1.6"
          bundler-cache: true

      - name: Install Pods
        run: |
          set -euxo pipefail
          cd ios
          # BlueWallet 通常用 bundler 管 cocoapods
          bundle exec pod --version
          bundle exec pod install --verbose

      - name: Sanity check workspace/scheme
        run: |
          set -euxo pipefail
          test -d "${WORKSPACE}"
          xcodebuild -list -workspace "${WORKSPACE}"
          xcodebuild -list -workspace "${WORKSPACE}" | sed -n '1,200p'

      # 关键：不签名归档（用于后续自己签名）
      - name: Build archive (NO code signing)
        run: |
          set -euxo pipefail
          mkdir -p build

          # 让 Xcode 构建脚本能找到 node
          export NODE_BINARY="$(command -v node)"
          echo "NODE_BINARY=$NODE_BINARY"

          xcodebuild \
            -workspace "${WORKSPACE}" \
            -scheme "${SCHEME}" \
            -configuration "${CONFIGURATION}" \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -archivePath "${ARCHIVE_PATH}" \
            archive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            PROVISIONING_PROFILE="" \
            COMPILER_INDEX_STORE_ENABLE=NO \
            SWIFT_TREAT_WARNINGS_AS_ERRORS=NO \
            SWIFT_STRICT_CONCURRENCY=minimal

      # 关键：手工打包 Payload => unsigned IPA
      - name: Package unsigned IPA
        run: |
          set -euxo pipefail

          APP_PATH="${ARCHIVE_PATH}/Products/Applications/${SCHEME}.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "ERROR: App not found at: $APP_PATH"
            echo "Archive contents:"
            find "${ARCHIVE_PATH}" -maxdepth 4 -type d -name "*.app" -print
            exit 1
          fi

          rm -rf Payload "${IPA_NAME}"
          mkdir -p Payload
          ditto "$APP_PATH" "Payload/${SCHEME}.app"

          # 生成 .ipa（本质是 zip，根目录必须有 Payload/xxx.app）
          /usr/bin/zip -qry "${IPA_NAME}" Payload

          echo "Built unsigned IPA: ${IPA_NAME}"
          ls -lah "${IPA_NAME}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: BlueWallet-unsigned-ipa
          path: ${{ env.IPA_NAME }}
          if-no-files-found: error
