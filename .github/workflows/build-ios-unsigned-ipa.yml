name: iOS Unsigned IPA (BlueWallet)

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [ master, main ]

concurrency:
  group: ios-unsigned-ipa-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write

jobs:
  build-ios-unsigned-ipa:
    runs-on: macos-latest
    timeout-minutes: 90

    env:
      CI: "true"
      NPM_CONFIG_AUDIT: "false"
      NPM_CONFIG_FUND: "false"

      WORKSPACE: ios/BlueWallet.xcworkspace
      SCHEME: BlueWallet
      CONFIGURATION: Release

      ARCHIVE_PATH: build/BlueWallet-Unsigned.xcarchive
      IPA_NAME: BlueWallet-unsigned.ipa

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Environment info
        shell: bash
        run: |
          set -euxo pipefail
          sw_vers
          xcodebuild -version
          xcodebuild -showsdks

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install JS dependencies
        shell: bash
        run: |
          set -euxo pipefail
          if [ -f package-lock.json ]; then
            npm ci
          elif [ -f yarn.lock ]; then
            corepack enable
            yarn --version
            yarn install --frozen-lockfile
          elif [ -f pnpm-lock.yaml ]; then
            corepack enable
            pnpm --version
            pnpm install --frozen-lockfile
          else
            npm install
          fi

      # 自动识别项目要求的 Ruby 版本（优先 .ruby-version，其次 Gemfile）
      - name: Detect Ruby version (from repo)
        id: rubyver
        shell: bash
        run: |
          set -euo pipefail
          RUBY_VER=""

          if [ -f .ruby-version ]; then
            RUBY_VER="$(head -n 1 .ruby-version | tr -d '[:space:]')"
          fi

          if [ -z "$RUBY_VER" ]; then
            for f in Gemfile ios/Gemfile; do
              if [ -f "$f" ]; then
                v="$(grep -E '^\s*ruby\s+["'\'']([0-9]+\.[0-9]+\.[0-9]+)["'\'']' "$f" \
                  | head -n 1 \
                  | sed -E 's/^\s*ruby\s+["'\'']([0-9]+\.[0-9]+\.[0-9]+)["'\''].*/\1/')"
                if [ -n "${v:-}" ]; then
                  RUBY_VER="$v"
                  break
                fi
              fi
            done
          fi

          if [ -z "$RUBY_VER" ]; then
            RUBY_VER="3.1.6"
          fi

          echo "ruby=$RUBY_VER" >> "$GITHUB_OUTPUT"
          echo "Detected Ruby: $RUBY_VER"

      - name: Setup Ruby (match repo requirement)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ steps.rubyver.outputs.ruby }}
          bundler-cache: ${{ hashFiles('Gemfile.lock', 'ios/Gemfile.lock') != '' }}

      - name: Ensure CocoaPods available
        shell: bash
        run: |
          set -euxo pipefail
          if ! command -v pod >/dev/null 2>&1; then
            sudo gem install cocoapods -N
          fi
          pod --version

      - name: Install iOS Pods
        shell: bash
        run: |
          set -euxo pipefail
          test -d ios
          test -f ios/Podfile

          # 先走 RN 推荐
          npx pod-install || true

          # 兜底：确保 Pods 一定装上
          if [ ! -d ios/Pods ]; then
            if [ -f ios/Gemfile ]; then
              (cd ios && bundle exec pod install --repo-update)
            elif [ -f Gemfile ]; then
              (cd ios && bundle exec pod install --repo-update)
            else
              (cd ios && pod install --repo-update)
            fi
          fi

      - name: Sanity check workspace/scheme
        shell: bash
        run: |
          set -euxo pipefail
          test -d "${WORKSPACE}"
          xcodebuild -list -workspace "${WORKSPACE}" | sed -n '1,220p'

      - name: Build archive (NO signing)
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p build

          export NODE_BINARY="$(command -v node)"
          echo "NODE_BINARY=$NODE_BINARY"

          set +e
          xcodebuild \
            -workspace "${WORKSPACE}" \
            -scheme "${SCHEME}" \
            -configuration "${CONFIGURATION}" \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -archivePath "${ARCHIVE_PATH}" \
            SKIP_INSTALL=NO \
            ENABLE_BITCODE=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            PROVISIONING_PROFILE="" \
            SWIFT_TREAT_WARNINGS_AS_ERRORS=NO \
            GCC_TREAT_WARNINGS_AS_ERRORS=NO \
            SWIFT_STRICT_CONCURRENCY=minimal \
            SWIFT_VERSION=5.9 \
            archive | tee build/xcodebuild.log
          RET=${PIPESTATUS[0]}
          set -e
          exit $RET

      - name: Package unsigned IPA (Payload/*.app)
        shell: bash
        run: |
          set -euxo pipefail
          test -d "${ARCHIVE_PATH}"

          APP_DIR="$(find "${ARCHIVE_PATH}/Products/Applications" -maxdepth 1 -type d -name '*.app' | head -n 1 || true)"
          if [ -z "$APP_DIR" ] || [ ! -d "$APP_DIR" ]; then
            echo "No .app found in xcarchive:"
            find "${ARCHIVE_PATH}" -maxdepth 5 -type d -name "*.app" -print || true
            exit 1
          fi

          rm -rf Payload "${IPA_NAME}"
          mkdir -p Payload
          /usr/bin/ditto "$APP_DIR" "Payload/$(basename "$APP_DIR")"
          /usr/bin/zip -qry "${IPA_NAME}" Payload

          echo "IPA created:"
          ls -lah "${IPA_NAME}"

      # ✅ 关键：强校验 + 上传 Artifact（找不到就 fail，避免“成功但没产物”）
      - name: Verify IPA exists
        shell: bash
        run: |
          set -euxo pipefail
          test -f "${IPA_NAME}"
          ls -lah "${IPA_NAME}"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: BlueWallet-unsigned-ipa
          path: ${{ env.IPA_NAME }}
          if-no-files-found: error
          retention-days: 7

      - name: Upload logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-logs
          path: |
            build/xcodebuild.log
          if-no-files-found: ignore
          retention-days: 7
