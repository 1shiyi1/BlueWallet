name: iOS Unsigned IPA (BlueWallet)

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [ master, main ]

concurrency:
  group: ios-unsigned-ipa-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  build-ios-unsigned-ipa:
    runs-on: macos-latest
    timeout-minutes: 75

    env:
      CI: "true"
      NPM_CONFIG_AUDIT: "false"
      NPM_CONFIG_FUND: "false"
      WORKSPACE: ios/BlueWallet.xcworkspace
      SCHEME: BlueWallet
      CONFIGURATION: Release
      ARCHIVE_PATH: build/BlueWallet-Unsigned.xcarchive
      IPA_NAME: BlueWallet-unsigned.ipa

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Environment info
        shell: bash
        run: |
          set -euxo pipefail
          sw_vers
          xcodebuild -version
          xcodebuild -showsdks

      - name: Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install JS dependencies
        shell: bash
        run: |
          set -euxo pipefail
          if [ -f package-lock.json ]; then
            npm ci
          elif [ -f yarn.lock ]; then
            corepack enable
            yarn --version
            yarn install --frozen-lockfile
          elif [ -f pnpm-lock.yaml ]; then
            corepack enable
            pnpm --version
            pnpm install --frozen-lockfile
          else
            npm install
          fi

      # ✅ 自动识别项目要求的 Ruby 版本（优先 .ruby-version，其次 Gemfile）
      - name: Detect Ruby version (from repo)
        id: rubyver
        shell: bash
        run: |
          set -euo pipefail
          RUBY_VER=""

          if [ -f .ruby-version ]; then
            RUBY_VER="$(head -n 1 .ruby-version | tr -d '[:space:]')"
          fi

          if [ -z "$RUBY_VER" ]; then
            for f in Gemfile ios/Gemfile; do
              if [ -f "$f" ]; then
                v="$(grep -E '^\s*ruby\s+["'\'']([0-9]+\.[0-9]+\.[0-9]+)["'\'']' "$f" \
                  | head -n 1 \
                  | sed -E 's/^\s*ruby\s+["'\'']([0-9]+\.[0-9]+\.[0-9]+)["'\''].*/\1/')"
                if [ -n "${v:-}" ]; then
                  RUBY_VER="$v"
                  break
                fi
              fi
            done
          fi

          if [ -z "$RUBY_VER" ]; then
            RUBY_VER="3.1.6"
          fi

          echo "ruby=$RUBY_VER" >> "$GITHUB_OUTPUT"
          echo "Detected Ruby: $RUBY_VER"

      - name: Setup Ruby (match repo requirement)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ steps.rubyver.outputs.ruby }}
          bundler-cache: ${{ hashFiles('Gemfile.lock', 'ios/Gemfile.lock') != '' }}

      - name: Ensure CocoaPods available
        shell: bash
        run: |
          set -euxo pipefail
          if ! command -v pod >/dev/null 2>&1; then
            sudo gem install cocoapods -N
          fi
          pod --version

      # ✅ 按 BlueWallet README 常见做法：npx pod-install（失败再兜底 pod install）
      - name: Install iOS Pods
        shell: bash
        run: |
          set -euxo pipefail
          test -d ios
          test -f ios/Podfile

          npx pod-install || true

          if [ ! -d ios/Pods ]; then
            if [ -f ios/Gemfile ]; then
              (cd ios && bundle exec pod install --repo-update)
            elif [ -f Gemfile ]; then
              (cd ios && bundle exec pod install --repo-update)
            else
              (cd ios && pod install --repo-update)
            fi
          fi

      - name: Sanity check workspace/scheme
        shell: bash
        run: |
          set -euxo pipefail
          test -d "${WORKSPACE}"
          xcodebuild -list -workspace "${WORKSPACE}" | sed -n '1,220p'
