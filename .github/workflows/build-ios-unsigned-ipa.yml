name: Build iOS Unsigned IPA (No Signing)

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [ master, main ]

concurrency:
  group: ios-unsigned-ipa-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  ios-unsigned-ipa:
    runs-on: macos-14
    timeout-minutes: 75

    env:
      CI: "true"
      NPM_CONFIG_AUDIT: "false"
      NPM_CONFIG_FUND: "false"
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Select Xcode (stable)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "15.4"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Setup Ruby (for CocoaPods / Bundler)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true

      - name: Preflight (show repo layout)
        shell: bash
        run: |
          set -euxo pipefail
          echo "Xcode:"
          xcodebuild -version
          echo "Node:"
          node -v
          echo "Ruby:"
          ruby -v
          echo "Top-level files:"
          ls -lah
          echo "iOS folder:"
          ls -lah ios || true
          echo "Workspaces/projects under ios/:"
          find ios -maxdepth 2 -name "*.xcworkspace" -o -name "*.xcodeproj" || true

      - name: Install JS dependencies (npm/yarn/pnpm fallback)
        shell: bash
        run: |
          set -euxo pipefail
          if [ -f package-lock.json ]; then
            npm ci
          elif [ -f yarn.lock ]; then
            corepack enable
            yarn --version
            yarn install --frozen-lockfile
          elif [ -f pnpm-lock.yaml ]; then
            corepack enable
            pnpm --version
            pnpm install --frozen-lockfile
          else
            npm install
          fi

      - name: Install iOS Pods (multi-fallback)
        shell: bash
        run: |
          set -euxo pipefail
          if [ ! -d ios ] || [ ! -f ios/Podfile ]; then
            echo "No ios/Podfile found; skip pods."
            exit 0
          fi

          # 1) 若有 Gemfile，优先 bundle exec pod install（最可控）
          if [ -f ios/Gemfile ] || [ -f Gemfile ]; then
            echo "Gemfile detected -> bundle exec pod install"
            (cd ios && bundle exec pod install) && exit 0 || true
          fi

          # 2) RN 常见方式
          echo "Try npx pod-install"
          npx pod-install && exit 0 || true

          # 3) 兜底：pod install --repo-update（最慢但最稳）
          echo "Fallback: pod install --repo-update"
          (cd ios && pod install --repo-update)

      - name: Detect workspace/project & scheme (robust)
        id: detect
        shell: bash
        run: |
          set -euxo pipefail

          python3 - <<'PY'
          import json, os, subprocess, sys
          from pathlib import Path

          ios = Path("ios")
          if not ios.exists():
              print("::error::No ios/ directory found")
              sys.exit(1)

          # Prefer workspace, then project. Prefer names containing 'BlueWallet' if available.
          workspaces = sorted([p for p in ios.glob("*.xcworkspace") if p.is_dir()],
                              key=lambda p: (("bluewallet" not in p.name.lower()), p.name.lower()))
          projects = sorted([p for p in ios.glob("*.xcodeproj") if p.is_dir()],
                            key=lambda p: (("bluewallet" not in p.name.lower()), p.name.lower()))

          candidates = []
          for w in workspaces:
              candidates.append(("workspace", str(w)))
          for p in projects:
              candidates.append(("project", str(p)))

          if not candidates:
              print("::error::No .xcworkspace or .xcodeproj found under ios/")
              sys.exit(1)

          def run_list(kind, path):
              cmd = ["xcodebuild", "-list", "-json", f"-{kind}", path]
              r = subprocess.run(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
              if r.returncode != 0:
                  return None, r.stderr.strip()
              try:
                  return json.loads(r.stdout), None
              except Exception as e:
                  return None, f"json parse failed: {e}"

          chosen = None
          chosen_errs = []

          # pick first candidate that yields schemes
          for kind, path in candidates:
              data, err = run_list(kind, path)
              if not data:
                  chosen_errs.append((kind, path, err))
                  continue
              # xcodebuild -list -json structure
              # workspace: {"workspace": {"schemes":[...] ...}}
              # project:   {"project": {"schemes":[...] ...}}
              root = data.get(kind) or {}
              schemes = root.get("schemes") or []
              if schemes:
                  chosen = (kind, path, schemes)
                  break
              chosen_errs.append((kind, path, "no schemes"))

          if not chosen:
              print("::error::Could not get schemes from any workspace/project")
              for kind, path, err in chosen_errs:
                  print(f"::error::{kind} {path} -> {err}")
              sys.exit(1)

          kind, path, schemes = chosen
          # prefer BlueWallet scheme if present
          scheme = "BlueWallet" if "BlueWallet" in schemes else schemes[0]

          # write outputs
          out = os.environ["GITHUB_OUTPUT"]
          with open(out, "a", encoding="utf-8") as f:
              f.write(f"container_kind={kind}\n")
              f.write(f"container_path={path}\n")
              f.write(f"scheme={scheme}\n")

          print(f"Selected: {kind}={path}, scheme={scheme}")
          PY

      - name: Build archive (NO signing, stable output)
        shell: bash
        run: |
          set -euxo pipefail

          KIND="${{ steps.detect.outputs.container_kind }}"
          CONTAINER="${{ steps.detect.outputs.container_path }}"
          SCHEME="${{ steps.detect.outputs.scheme }}"

          mkdir -p build
          DERIVED="build/DerivedData"
          ARCHIVE_PATH="build/Unsigned.xcarchive"
          LOG="build/xcodebuild.log"

          if [ "$KIND" = "workspace" ]; then
            CONTAINER_ARGS=(-workspace "$CONTAINER")
          else
            CONTAINER_ARGS=(-project "$CONTAINER")
          fi

          # archive 比 build 更稳定（产物路径固定在 xcarchive 里）
          set +e
          xcodebuild \
            "${CONTAINER_ARGS[@]}" \
            -scheme "$SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -derivedDataPath "$DERIVED" \
            -archivePath "$ARCHIVE_PATH" \
            ENABLE_BITCODE=NO \
            SKIP_INSTALL=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            CODE_SIGN_STYLE=Manual \
            archive | tee "$LOG"
          XCB_RET=${PIPESTATUS[0]}
          set -e

          if [ $XCB_RET -ne 0 ]; then
            echo "xcodebuild failed with $XCB_RET"
            exit $XCB_RET
          fi

          echo "Archive created at: $ARCHIVE_PATH"
          ls -lah build

      - name: Package unsigned .ipa (Payload/*.app from xcarchive)
        shell: bash
        run: |
          set -euxo pipefail

          ARCHIVE_PATH="build/Unsigned.xcarchive"
          if [ ! -d "$ARCHIVE_PATH" ]; then
            echo "Archive not found: $ARCHIVE_PATH"
            ls -lah build
            exit 1
          fi

          APP_DIR="$(find "$ARCHIVE_PATH/Products/Applications" -maxdepth 1 -type d -name '*.app' | head -n 1 || true)"
          if [ -z "$APP_DIR" ] || [ ! -d "$APP_DIR" ]; then
            echo "No .app found in archive Applications directory."
            find "$ARCHIVE_PATH" -maxdepth 4 -type d -name "*.app" -print || true
            exit 1
          fi

          echo "APP_DIR=$APP_DIR"

          rm -rf Payload
          mkdir -p Payload
          /usr/bin/ditto "$APP_DIR" "Payload/$(basename "$APP_DIR")"

          IPA="bluewallet-unsigned.ipa"
          rm -f "$IPA"
          /usr/bin/zip -qry "$IPA" Payload

          echo "Created: $IPA"
          ls -lah "$IPA"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: bluewallet-ios-unsigned-ipa
          path: bluewallet-unsigned.ipa
          if-no-files-found: error

      - name: Upload build logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-logs
          path: |
            build/xcodebuild.log
            build/DerivedData/Logs/**/*
            build/Unsigned.xcarchive/**/*
          if-no-files-found: ignore
