name: Build iOS Unsigned Archive

on:
  workflow_dispatch:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: read

jobs:
  ios-unsigned-archive:
    runs-on: macos-14
    env:
      BUILD_CONFIGURATION: Release

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.1.6"

      - name: Cache Ruby gems
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-ruby-${{ hashFiles('Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-ruby-

      - name: Install Ruby gems
        run: |
          bundle config path vendor/bundle
          bundle install --jobs 4 --retry 3 --quiet

      - name: Install Node dependencies
        run: npm ci

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install CocoaPods dependencies
        run: bundle exec fastlane ios install_pods

      # 如果你原来就需要删 Watch target 才能编译，就保留；不需要就删掉这两步
      - name: Delete Apple Watch target
        run: |
          bundle exec ruby <<'RUBY'
          require 'xcodeproj'
          project_path = 'ios/BlueWallet.xcodeproj'
          project = Xcodeproj::Project.open(project_path)
          target_names = %w[BlueWalletWatch]
          removed_any = false
          target_names.each do |target_name|
            target = project.targets.find { |t| t.name == target_name }
            next unless target
            puts "Removing target #{target_name}"
            target.dependencies.each(&:remove_from_project)
            target.build_phases.each(&:remove_from_project)
            project.targets.delete(target)
            removed_any = true
          end
          main_target = project.targets.find { |t| t.name == 'BlueWallet' }
          if main_target
            main_target.build_phases.select { |phase| phase.display_name == 'Embed Watch Content' }.each do |phase|
              puts "Removing build phase #{phase.display_name}"
              phase.remove_from_project
              main_target.build_phases.delete(phase)
              removed_any = true
            end
          end
          project.save if removed_any
          RUBY
      - name: Remove Watch schemes
        run: rm -f ios/BlueWallet.xcodeproj/xcshareddata/xcschemes/BlueWalletWatch.xcscheme

      - name: Build unsigned archive (device)
        working-directory: ios
        env:
          RCT_NO_LAUNCH_PACKAGER: "1"
        run: |
          set -eo pipefail

          xcodebuild \
            -workspace BlueWallet.xcworkspace \
            -scheme BlueWallet \
            -configuration "${BUILD_CONFIGURATION}" \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -archivePath build/BlueWallet-unsigned.xcarchive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            clean archive

          ls -la build
          test -d build/BlueWallet-unsigned.xcarchive

      - name: Upload unsigned archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: BlueWallet-iOS-unsigned-xcarchive
          path: ios/build/BlueWallet-unsigned.xcarchive
          retention-days: 7
