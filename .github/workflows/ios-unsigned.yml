name: iOS Unsigned IPA (BlueWallet)

on:
  workflow_dispatch:

jobs:
  build_unsigned_ipa:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install JS deps
        run: |
          npm ci || npm install

      - name: Install iOS pods
        run: |
          npx pod-install

      # ✅ 关键：生成一个只编 iOS App 的 Scheme，避免 Watch 目标（BlueWalletWatch）参与构建
      - name: Create iOS-only scheme (exclude Watch/Extensions)
        run: |
          python3 <<'PY'
          import re, pathlib, sys

          pbx = pathlib.Path("ios/BlueWallet.xcodeproj/project.pbxproj")
          s = pbx.read_text()

          # 找到 iOS 主 App Target: BlueWallet 的 target id
          m = re.search(r'([A-F0-9]{24}) /\* BlueWallet \*/ = \{.*?isa = PBXNativeTarget;.*?name = BlueWallet;.*?\};', s, re.S)
          if not m:
            print("ERROR: Cannot find PBXNativeTarget named 'BlueWallet'", file=sys.stderr)
            sys.exit(1)

          target_id = m.group(1)

          # 找到它的 productName / productRef，尽量推断 BuildableName
          # 兜底就用 BlueWallet.app
          buildable_name = "BlueWallet.app"

          scheme_dir = pathlib.Path("ios/BlueWallet.xcodeproj/xcshareddata/xcschemes")
          scheme_dir.mkdir(parents=True, exist_ok=True)

          scheme_path = scheme_dir / "BlueWallet-iOSOnly.xcscheme"

          scheme_xml = f'''<?xml version="1.0" encoding="UTF-8"?>
          <Scheme
             LastUpgradeVersion="9999"
             version="1.7">
             <BuildAction parallelizeBuildables="YES" buildImplicitDependencies="NO">
                <BuildActionEntries>
                   <BuildActionEntry buildForTesting="YES" buildForRunning="YES" buildForProfiling="YES" buildForArchiving="YES" buildForAnalyzing="YES">
                      <BuildableReference
                         BuildableIdentifier="primary"
                         BlueprintIdentifier="{target_id}"
                         BuildableName="{buildable_name}"
                         BlueprintName="BlueWallet"
                         ReferencedContainer="container:BlueWallet.xcodeproj">
                      </BuildableReference>
                   </BuildActionEntry>
                </BuildActionEntries>
             </BuildAction>
             <TestAction buildConfiguration="Release" selectedDebuggerIdentifier="Xcode.DebuggerFoundation.Debugger.LLDB" selectedLauncherIdentifier="Xcode.DebuggerFoundation.Launcher.LLDB">
             </TestAction>
             <LaunchAction buildConfiguration="Release" selectedDebuggerIdentifier="Xcode.DebuggerFoundation.Debugger.LLDB" selectedLauncherIdentifier="Xcode.DebuggerFoundation.Launcher.LLDB" launchStyle="0" useCustomWorkingDirectory="NO" ignoresPersistentStateOnLaunch="NO" debugDocumentVersioning="YES">
                <BuildableProductRunnable runnableDebuggingMode="0">
                   <BuildableReference
                      BuildableIdentifier="primary"
                      BlueprintIdentifier="{target_id}"
                      BuildableName="{buildable_name}"
                      BlueprintName="BlueWallet"
                      ReferencedContainer="container:BlueWallet.xcodeproj">
                   </BuildableReference>
                </BuildableProductRunnable>
             </LaunchAction>
             <ProfileAction buildConfiguration="Release" shouldUseLaunchSchemeArgsEnv="YES" savedToolIdentifier="" useCustomWorkingDirectory="NO" debugDocumentVersioning="YES">
                <BuildableProductRunnable runnableDebuggingMode="0">
                   <BuildableReference
                      BuildableIdentifier="primary"
                      BlueprintIdentifier="{target_id}"
                      BuildableName="{buildable_name}"
                      BlueprintName="BlueWallet"
                      ReferencedContainer="container:BlueWallet.xcodeproj">
                   </BuildableReference>
                </BuildableProductRunnable>
             </ProfileAction>
             <AnalyzeAction buildConfiguration="Release">
             </AnalyzeAction>
             <ArchiveAction buildConfiguration="Release" revealArchiveInOrganizer="YES">
             </ArchiveAction>
          </Scheme>
          '''

          scheme_path.write_text(scheme_xml)
          print(f"Created scheme: {scheme_path} (target id {target_id})")
          PY

      - name: Print schemes (for troubleshooting)
        run: |
          xcodebuild -list -workspace ios/BlueWallet.xcworkspace

      # 1) 修复：watchOS storyboard 不应被 iOS target 当资源编译（你之前遇到的那个）
      # 2) 加固：禁用 Bugsnag 上传脚本 phase（CI 缺 token 时常见炸点）
      - name: Patch Xcode project (watch storyboard + disable Bugsnag upload scripts)
        run: |
          python3 <<'PY'
          import re, pathlib, sys

          pbx = pathlib.Path("ios/BlueWallet.xcodeproj/project.pbxproj")
          s = pbx.read_text()

          # ---------- A) Remove watch storyboard from iOS target Resources ----------
          m = re.search(r'([A-F0-9]{24}) /\* BlueWallet \*/ = \{.*?isa = PBXNativeTarget;.*?name = BlueWallet;.*?\};', s, re.S)
          if not m:
            print("ERROR: Cannot find PBXNativeTarget named 'BlueWallet'", file=sys.stderr)
            sys.exit(1)
          target_block = m.group(0)

          bm = re.search(r'buildPhases = \((.*?)\);', target_block, re.S)
          if not bm:
            print("ERROR: Cannot find buildPhases for target 'BlueWallet'", file=sys.stderr)
            sys.exit(1)
          phase_ids = re.findall(r'([A-F0-9]{24})', bm.group(1))

          res_phase_id = None
          for pid in phase_ids:
            pm = re.search(rf'{pid} /\* .*? \*/ = \{{.*?isa = PBXResourcesBuildPhase;.*?\}};', s, re.S)
            if pm:
              res_phase_id = pid
              break
          if not res_phase_id:
            print("ERROR: Cannot find PBXResourcesBuildPhase for target 'BlueWallet'", file=sys.stderr)
            sys.exit(1)

          phase_pat = rf'({res_phase_id} /\* .*? \*/ = \{{.*?isa = PBXResourcesBuildPhase;.*?files = \((.*?)\);.*?\}};)'
          pm = re.search(phase_pat, s, re.S)
          if not pm:
            print("ERROR: Cannot parse Resources build phase block", file=sys.stderr)
            sys.exit(1)

          phase_full = pm.group(1)
          files_block = pm.group(2)

          file_ids = re.findall(r'([A-F0-9]{24}) /\* .*? \*/', files_block)

          watch_build_file_ids = set()
          for fid in file_ids:
            bm = re.search(
              rf'{fid} /\* (.*?) \*/ = \{{.*?isa = PBXBuildFile;.*?fileRef = ([A-F0-9]{{24}}) /\* (.*?) \*/;.*?\}};',
              s, re.S
            )
            if not bm:
              continue
            build_comment = bm.group(1)
            fileref_id = bm.group(2)

            if "Interface.storyboard" not in build_comment:
              continue

            frm = re.search(rf'{fileref_id} /\* .*? \*/ = \{{.*?isa = PBXFileReference;.*?path = ([^;]+);', s, re.S)
            if frm and "BlueWalletWatch" in frm.group(1):
              watch_build_file_ids.add(fid)

          if watch_build_file_ids:
            new_files_block = files_block
            for fid in watch_build_file_ids:
              new_files_block = re.sub(rf'\n\s*{fid} /\* .*? \*/,', '', new_files_block)
            new_phase_full = phase_full.replace(files_block, new_files_block)
            s = s.replace(phase_full, new_phase_full)
            print(f"Patched: removed {len(watch_build_file_ids)} watch storyboard entries from iOS Resources.")
          else:
            print("Patch: no watch storyboard entries found in iOS Resources (skip).")

          # ---------- B) Disable Bugsnag upload script phases ----------
          script_names = [
            "Upload source maps to Bugsnag",
            "Upload Bugsnag dSYM",
          ]
          changed = 0
          for name in script_names:
            pattern = rf'([A-F0-9]{{24}} /\* {re.escape(name)} \*/ = \{{.*?isa = PBXShellScriptBuildPhase;.*?shellScript = )(".*?")(\s*;.*?\}};)'
            def repl(m):
              nonlocal changed
              changed += 1
              return m.group(1) + '"exit 0\\n"' + m.group(3)
            s, _ = re.subn(pattern, repl, s, flags=re.S)

          print(f"Patched: disabled {changed} Bugsnag upload script phase(s).")

          pbx.write_text(s)
          PY

      # ✅ 用 iOS-only scheme 归档：这样 Watch 的 Assets.xcassets 不会被编译
      - name: Archive iOS only (NO code signing, keep full log + xcresult)
        run: |
          set -uxo pipefail
          ARCHIVE_PATH="$RUNNER_TEMP/unsigned.xcarchive"
          LOG_PATH="$RUNNER_TEMP/xcodebuild-archive.log"
          RESULT_PATH="$RUNNER_TEMP/build.xcresult"

          set +e
          xcodebuild \
            -workspace ios/BlueWallet.xcworkspace \
            -scheme BlueWallet-iOSOnly \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -archivePath "$ARCHIVE_PATH" \
            -resultBundlePath "$RESULT_PATH" \
            clean archive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            DEVELOPMENT_TEAM="" \
            CODE_SIGN_STYLE=Manual \
            | tee "$LOG_PATH"

          XC=$?
          echo "xcodebuild exit code: $XC"

          echo "===== grep key lines ====="
          grep -nE "error:|fatal error:|ld: |Undefined symbols|clang: error|Swift.*error|ARCHIVE FAILED|\*\* BUILD FAILED \*\*|Command PhaseScriptExecution failed|Signing for|requires a development team|No profiles for|Provisioning profile|CodeSign" \
            "$LOG_PATH" | tail -n 200 || true

          echo "===== tail last 200 lines ====="
          tail -n 200 "$LOG_PATH" || true

          exit $XC

      - name: Create unsigned IPA from xcarchive
        run: |
          set -euxo pipefail
          ARCHIVE_PATH="$RUNNER_TEMP/unsigned.xcarchive"
          OUT_DIR="$RUNNER_TEMP/out"
          mkdir -p "$OUT_DIR/Payload"

          cp -R "$ARCHIVE_PATH/Products/Applications/"*.app "$OUT_DIR/Payload/"
          (cd "$OUT_DIR" && /usr/bin/zip -r "BlueWallet-unsigned.ipa" "Payload")

          ls -lah "$OUT_DIR"

      - name: Upload artifacts (ipa/xcarchive/logs/xcresult)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-build
          path: |
            ${{ runner.temp }}/out/BlueWallet-unsigned.ipa
            ${{ runner.temp }}/unsigned.xcarchive
            ${{ runner.temp }}/xcodebuild-archive.log
            ${{ runner.temp }}/build.xcresult
