name: iOS Unsigned IPA (BlueWallet)

on:
  workflow_dispatch:

jobs:
  build_unsigned_ipa:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install JS deps
        run: |
          npm ci || npm install

      - name: Install iOS pods
        run: |
          npx pod-install

      - name: Print schemes (for troubleshooting)
        run: |
          xcodebuild -list -workspace ios/BlueWallet.xcworkspace

      # ✅ 关键修复：把 watchOS storyboard 从 iOS App target 的 Resources 里移除
      # 原因：watchOS storyboard 被当成 iOS storyboard 编译，触发
      # "watchOS storyboards do not support target device type iphone"
      - name: Patch Xcode project (exclude watch storyboard from iOS resources)
        run: |
          python3 <<'PY'
          import re, pathlib, sys

          pbx = pathlib.Path("ios/BlueWallet.xcodeproj/project.pbxproj")
          s = pbx.read_text()

          # 1) 找到名为 BlueWallet 的 PBXNativeTarget
          m = re.search(r'([A-F0-9]{24}) /\* BlueWallet \*/ = \{.*?isa = PBXNativeTarget;.*?name = BlueWallet;.*?\};',
                        s, re.S)
          if not m:
            print("ERROR: Cannot find PBXNativeTarget named 'BlueWallet'", file=sys.stderr)
            sys.exit(1)
          target_block = m.group(0)

          # 2) 找出这个 target 的 buildPhases ids
          bm = re.search(r'buildPhases = \((.*?)\);', target_block, re.S)
          if not bm:
            print("ERROR: Cannot find buildPhases for target 'BlueWallet'", file=sys.stderr)
            sys.exit(1)
          phase_ids = re.findall(r'([A-F0-9]{24})', bm.group(1))

          # 3) 在这些 phase 里定位 PBXResourcesBuildPhase（iOS app 的 Resources phase）
          res_phase_id = None
          for pid in phase_ids:
            pm = re.search(rf'{pid} /\* .*? \*/ = \{{.*?isa = PBXResourcesBuildPhase;.*?\}};', s, re.S)
            if pm:
              res_phase_id = pid
              break
          if not res_phase_id:
            print("ERROR: Cannot find PBXResourcesBuildPhase for target 'BlueWallet'", file=sys.stderr)
            sys.exit(1)

          # 4) 把 Resources phase 的 files 列表拿出来
          phase_pat = rf'({res_phase_id} /\* .*? \*/ = \{{.*?isa = PBXResourcesBuildPhase;.*?files = \((.*?)\);.*?\}};)'
          pm = re.search(phase_pat, s, re.S)
          if not pm:
            print("ERROR: Cannot parse Resources build phase block", file=sys.stderr)
            sys.exit(1)

          phase_full = pm.group(1)
          files_block = pm.group(2)

          # 5) files 列表里每个是 PBXBuildFile id，我们找出其中指向 BlueWalletWatch/.../Interface.storyboard 的
          file_ids = re.findall(r'([A-F0-9]{24}) /\* .*? \*/', files_block)

          watch_build_file_ids = set()
          for fid in file_ids:
            bm = re.search(
              rf'{fid} /\* (.*?) \*/ = \{{.*?isa = PBXBuildFile;.*?fileRef = ([A-F0-9]{{24}}) /\* (.*?) \*/;.*?\}};',
              s, re.S
            )
            if not bm:
              continue

            build_comment = bm.group(1)
            fileref_id = bm.group(2)

            # 只处理 Interface.storyboard 相关
            if "Interface.storyboard" not in build_comment:
              continue

            # 从 PBXFileReference 找 path，判断是否在 BlueWalletWatch 目录
            frm = re.search(rf'{fileref_id} /\* .*? \*/ = \{{.*?isa = PBXFileReference;.*?path = ([^;]+);',
                            s, re.S)
            if frm and "BlueWalletWatch" in frm.group(1):
              watch_build_file_ids.add(fid)

          if not watch_build_file_ids:
            print("No watch storyboard resource entries found in iOS Resources phase. Nothing to patch.")
            sys.exit(0)

          new_files_block = files_block
          for fid in watch_build_file_ids:
            new_files_block = re.sub(rf'\n\s*{fid} /\* .*? \*/,', '', new_files_block)

          new_phase_full = phase_full.replace(files_block, new_files_block)
          s2 = s.replace(phase_full, new_phase_full)
          pbx.write_text(s2)

          print(f"Patched OK: removed {len(watch_build_file_ids)} watch storyboard resource entries from iOS target Resources.")
          PY

      # 归档：禁用签名 + 指定 generic iOS 目标 + 把完整日志保存到文件
      - name: Archive (NO code signing, keep full log)
        run: |
          set -uxo pipefail
          ARCHIVE_PATH="$RUNNER_TEMP/unsigned.xcarchive"
          LOG_PATH="$RUNNER_TEMP/xcodebuild-archive.log"

          set +e
          xcodebuild \
            -workspace ios/BlueWallet.xcworkspace \
            -scheme BlueWallet \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -archivePath "$ARCHIVE_PATH" \
            clean archive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            DEVELOPMENT_TEAM="" \
            CODE_SIGN_STYLE=Manual \
            | tee "$LOG_PATH"

          XC=$?
          echo "xcodebuild exit code: $XC"

          echo "===== grep key lines ====="
          grep -nE "error:|ARCHIVE FAILED|\*\* BUILD FAILED \*\*|Command PhaseScriptExecution failed|Signing for|requires a development team|No profiles for|Provisioning profile|CodeSign" \
            "$LOG_PATH" | tail -n 120 || true

          echo "===== tail last 200 lines ====="
          tail -n 200 "$LOG_PATH" || true

          exit $XC

      # 归档成功后，把 .xcarchive 手工打包成 unsigned IPA
      - name: Create unsigned IPA from xcarchive
        run: |
          set -euxo pipefail
          ARCHIVE_PATH="$RUNNER_TEMP/unsigned.xcarchive"
          OUT_DIR="$RUNNER_TEMP/out"

          mkdir -p "$OUT_DIR/Payload"

          echo "Archive products:"
          ls -lah "$ARCHIVE_PATH/Products" || true
          ls -lah "$ARCHIVE_PATH/Products/Applications" || true

          cp -R "$ARCHIVE_PATH/Products/Applications/"*.app "$OUT_DIR/Payload/"

          (cd "$OUT_DIR" && /usr/bin/zip -r "BlueWallet-unsigned.ipa" "Payload")

          echo "Output:"
          ls -lah "$OUT_DIR"

      # 不管成功/失败都上传：IPA（若生成）、xcarchive（若生成）、以及完整 xcodebuild 日志
      - name: Upload artifacts (xcarchive + unsigned IPA + logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-build
          path: |
            ${{ runner.temp }}/unsigned.xcarchive
            ${{ runner.temp }}/out/BlueWallet-unsigned.ipa
            ${{ runner.temp }}/xcodebuild-archive.log
