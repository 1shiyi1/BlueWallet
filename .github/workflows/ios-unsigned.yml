name: iOS Unsigned IPA (BlueWallet)

on:
  workflow_dispatch:

jobs:
  build_unsigned_ipa:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install JS deps
        run: |
          npm ci || npm install

      - name: Install iOS pods
        run: |
          npx pod-install

      - name: Print schemes (for troubleshooting)
        run: |
          xcodebuild -list -workspace ios/BlueWallet.xcworkspace

      - name: Archive (NO code signing)
        run: |
          set -euxo pipefail
          ARCHIVE_PATH="$RUNNER_TEMP/unsigned.xcarchive"

          xcodebuild \
            -workspace ios/BlueWallet.xcworkspace \
            -scheme BlueWallet \
            -configuration Release \
            -sdk iphoneos \
            -archivePath "$ARCHIVE_PATH" \
            clean archive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            PROVISIONING_PROFILE_SPECIFIER=""

      - name: Create unsigned IPA from xcarchive
        run: |
          set -euxo pipefail
          ARCHIVE_PATH="$RUNNER_TEMP/unsigned.xcarchive"
          OUT_DIR="$RUNNER_TEMP/out"
          mkdir -p "$OUT_DIR/Payload"

          # Copy .app into Payload
          cp -R "$ARCHIVE_PATH/Products/Applications/"*.app "$OUT_DIR/Payload/"

          # Zip Payload => IPA
          (cd "$OUT_DIR" && /usr/bin/zip -r "BlueWallet-unsigned.ipa" "Payload")

          ls -lah "$OUT_DIR"

      - name: Upload artifacts (xcarchive + unsigned IPA)
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-build
          path: |
            ${{ runner.temp }}/unsigned.xcarchive
            ${{ runner.temp }}/out/BlueWallet-unsigned.ipa
